import time
import math
import random
import numpy as np
from circle_spectrum import CircleSpectrum
from expenvelope import Envelope
from transitions2 import transitions_envelope


# Configuration
WINDOW_DIM = 1920, 1080
BACKGROUND_COLOR = (20, 20, 20)
SHOW_DASHED_DISTANCE = False

SHOW_PLAYED_POSITIONS = True 
PLAYED_POSITION_DOT_WIDTH = 6
PLAYED_POSITION_FADE_TIME = 2
DRAW_CIRCLE_PULSES = True
CIRCLE_WIDTH = 3
SAVE_FRAMES = False
START_FRAME = 0
FRAME_RATE = 60
DRAW_CIRCLES = True

CIRCLE_COLOR = (80, 80, 80)
CIRCLE_CENTER_COLOR = (255, 255, 255)
CIRCLE_CENTER_DOT_WIDTH = 3
PATH_COLOR = (255, 100, 100)
PATH_DECAY_TIME = 5
PATH_WIDTH = 5
PATH_DOT_WIDTH = 7
SHOW_ONSETS = True 
ONSET_ENLARGEMENT_MUL = 2
ENLARGEMENT_DECAY_CONSTANT = 0.1

_start_time = time.time()


def restart_time():
    global _start_time
    _start_time = time.time()


def get_time():
    return (time.time() - _start_time)


def get_random_sines(num_sines, slowest_freq, freq_ratio, amp_ratio, freq_randomization=0,
                     amp_randomization=0, randomize_freq_sign=True, randomize_phase=True):
    log_freqs = [math.log(slowest_freq) + math.log(freq_ratio) * random.uniform(n - freq_randomization / 2, n + freq_randomization / 2)
                 for n in range(num_sines)]
    freqs = [round(math.exp(lf), 10) * (random.choice([-1, 1]) if randomize_freq_sign else 1) for lf in log_freqs]
    
    log_amps = [math.log(amp_ratio) * random.uniform(n - amp_randomization / 2, n + amp_randomization / 2)
                 for n in range(num_sines)]
    amps = [round(math.exp(la), 10) for la in log_amps]
    return [
        (f, a, random.uniform(0, math.tau) if randomize_phase else 0)
        for f, a in zip(freqs, reversed(amps))
    ]

# random.seed(14)
# sines = get_random_sines(4, 0.1, 2, 1.5, freq_randomization=0.5, amp_randomization=0.5)
# sines = [(0.09259259259259259, 0.4464285714285714, -5.92693289186054e-16), (0.4629629629629629, 0.0778011206670387, -0.7617419260477534), (-0.2777777777777778, 0.07780112066703865, 0.7617419260477537), (0.18518518518518517, 0.07458894919018154, -0.6066568835966398), (0.0, 0.0745889491901815, 0.6066568835966394), (-0.09259259259259259, 0.04609180880586724, 1.8767759487111393), (0.2777777777777778, 0.04609180880586722, -1.8767759487111393), (-1.0185185185185184, 0.037698412698412676, 6.135443030823237e-16), (-0.6481481481481481, 0.026466907880861312, -2.759022775272237), (0.8333333333333333, 0.026466907880861267, 2.7590227752722325), (0.5555555555555556, 0.024810765205970114, 1.3124939248177807), (-0.37037037037037035, 0.024810765205970083, -1.312493924817782), (0.7407407407407407, 0.024250064496701407, 0.0670041935546617), (-0.5555555555555556, 0.024250064496701338, -0.06700419355466326), (-0.18518518518518517, 0.023515026020494212, 2.886319214029976), (0.37037037037037035, 0.02351502602049417, -2.8863192140299763), (-0.7407407407407407, 0.01157618900634222, 1.226826990962476), (0.9259259259259258, 0.01157618900634219, -1.2268269909624785), (0.6481481481481481, 0.011311264137888286, 1.30454427764397), (-0.4629629629629629, 0.011311264137888244, -1.3045442776439717), (0.1388888888888889, 0.008692232411028032, 0.33167905759136573), (0.046296296296296294, 0.00869223241102785, -0.33167905759136773), (-0.41666666666666663, 0.007404571767010181, -2.6927091660243985), (0.6018518518518519, 0.007404571767010156, 2.6927091660243967), (-0.32407407407407407, 0.007104263434702683, -1.9145784879432843), (0.5092592592592592, 0.007104263434702676, 1.9145784879432748), (0.23148148148148145, 0.007064448829760071, 0.9176956346027572), (-0.046296296296296294, 0.007064448829760025, -0.9176956346027718), (-0.8333333333333333, 0.0062285407670074665, 1.7315306132000705), (1.0185185185185184, 0.0062285407670074336, -1.731530613200076), (0.6944444444444444, 0.006136991920696015, -2.653454288512399), (-0.5092592592592592, 0.006136991920696, 2.6534542885123944), (-0.23148148148148145, 0.005702156151996804, -1.3924639468379465), (0.41666666666666663, 0.005702156151996784, 1.3924639468379367), (-0.1388888888888889, 0.005322716750698317, -1.2252338285870366), (0.32407407407407407, 0.005322716750698301, 1.225233828587023), (-0.6018518518518519, 0.00401455334490139, 1.498493680046263), (0.787037037037037, 0.004014553344901376, -1.498493680046258), (-0.787037037037037, 0.0026048626249265024, -1.6607922446466414), (0.9722222222222222, 0.0026048626249264937, 1.6607922446466288)]
sines = [(0.15625, 0.427827380952381, -2.375710467855651e-16), (-2.34375, 0.046130952380952384, -2.102504719503229e-16), (-1.40625, 0.03298143337862212, 1.5355969651253876), (1.71875, 0.0329814333786221, -1.5355969651253865), (-0.15625, 0.030374535936283524, 1.7938087005248926), (0.46875, 0.0303745359362835, -1.793808700524891), (0.078125, 0.028474630327009025, 1.7836049467349886), (0.234375, 0.02847463032700899, -1.7836049467349873), (-2.421875, 0.023843925281914133, -1.7802569877456134), (-2.265625, 0.023843925281914122, 1.780256987745613), (-0.234375, 0.023276619483577742, 2.1693429571963674), (0.546875, 0.023276619483577694, -2.1693429571963683), (-1.328125, 0.02306302965983652, -1.314618593195049), (1.640625, 0.023063029659836507, 1.3146185931950478), (-0.46875, 0.022672880892526562, 1.7089569880335187), (0.78125, 0.022672880892526545, -1.7089569880335174), (1.09375, 0.02164323799780408, 3.019979287870374), (-0.78125, 0.021643237997804057, -3.019979287870375), (2.03125, 0.020865671231048277, 2.1268869956926557), (-1.71875, 0.020865671231048214, -2.126886995692652), (-1.484375, 0.02040509070148666, 2.3684686521395504), (1.796875, 0.02040509070148662, -2.3684686521395517), (0.3125, 0.019010704791122456, -0.7358317539686633), (0.0, 0.019010704791122456, 0.7358317539686634), (-1.171875, 0.017232675190529904, -0.7988535608335469), (1.484375, 0.017232675190529866, 0.7988535608335465), (0.625, 0.016598097488646213, -0.22678026591819195), (-0.3125, 0.016598097488646206, 0.22678026591819173), (1.015625, 0.012998888151524349, 0.3324449614715652), (-0.703125, 0.012998888151524344, -0.33244496147156416), (-2.1875, 0.012894900085583437, -2.6254977735999834), (-2.5, 0.012894900085583437, 2.625497773599984), (-1.5625, 0.011981549682378549, 0.570970399522978), (1.875, 0.01198154968237852, -0.5709703995229776), (-0.390625, 0.01183249235334397, -0.7929222589288756), (0.703125, 0.011832492353343958, 0.7929222589288775), (2.265625, 0.011234089831570348, 1.25108102318192), (-1.953125, 0.011234089831570312, -1.251081023181919), (-1.640625, 0.011033173846952076, 2.9061858018875273), (1.953125, 0.011033173846952059, -2.9061858018875304), (2.1875, 0.008981359699494524, -0.1323591172003846), (-1.875, 0.008981359699494512, 0.1323591172003839), (1.171875, 0.008621352604302081, -1.2682000487704386), (-0.859375, 0.008621352604302059, 1.2682000487704357), (-0.625, 0.006658473538783342, 2.60571783262026), (0.9375, 0.006658473538783309, -2.6057178326202606), (-1.25, 0.006093270083765921, 0.633643535459345), (1.5625, 0.006093270083765916, -0.6336435354593475), (1.25, 0.00541737508480376, -1.852248111790024), (-0.9375, 0.005417375084803749, 1.852248111790028), (-1.796875, 0.004746683944405849, -1.1139445444598337), (2.109375, 0.004746683944405803, 1.1139445444598275), (-2.03125, 0.003677084304595551, -0.4976588693914414), (2.34375, 0.0036770843045955074, 0.4976588693914387), (0.390625, 0.003616926711504927, -0.33038674558894354), (-0.078125, 0.003616926711504877, 0.3303867455889383), (1.40625, 0.0033688188757951946, 0.11065722117388818), (-1.09375, 0.0033688188757951733, -0.11065722117389311), (0.859375, 0.002821252729759223, -2.002962703884399), (-0.546875, 0.0028212527297592147, 2.0029627038843936), (-1.015625, 0.0027346549723193387, 1.4000565704490464), (1.328125, 0.00273465497231929, -1.4000565704490562), (2.421875, 8.371568783700348e-05, -0.6363838218607497), (-2.109375, 8.371568783698804e-05, 0.6363838218604915)]
circle_spectrum = CircleSpectrum(*sines, cutoff_index=transitions_envelope)
circle_spectrum_music = circle_spectrum
circle_spectrum_graphics = circle_spectrum.normalized(WINDOW_DIM[1] / 2)



# 13.613319158554077 0.5492606591783147 0.3367327528210926
