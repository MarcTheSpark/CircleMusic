import time
import math
import random
import numpy as np
from circle_spectrum import CircleSpectrum
from expenvelope import Envelope
from transitions import transitions_envelope


# Configuration
WINDOW_DIM = 1920, 1080
BACKGROUND_COLOR = (20, 20, 20)
SHOW_DASHED_DISTANCE = False

SHOW_PLAYED_POSITIONS = True 
PLAYED_POSITION_DOT_WIDTH = 6
PLAYED_POSITION_FADE_TIME = 2
DRAW_CIRCLE_PULSES = True
CIRCLE_WIDTH = 3
SAVE_FRAMES = False
FRAME_RATE = 60
DRAW_CIRCLES = True

CIRCLE_COLOR = (80, 80, 80)
CIRCLE_CENTER_COLOR = (255, 255, 255)
CIRCLE_CENTER_DOT_WIDTH = 3
PATH_COLOR = (255, 100, 100)
PATH_DECAY_TIME = 5
PATH_WIDTH = 5
PATH_DOT_WIDTH = 7
SHOW_ONSETS = True 
ONSET_ENLARGEMENT_MUL = 2
ENLARGEMENT_DECAY_CONSTANT = 0.1

_start_time = time.time()


def restart_time():
    global _start_time
    _start_time = time.time()


def get_time():
    return (time.time() - _start_time)


def get_random_sines(num_sines, slowest_freq, freq_ratio, amp_ratio, freq_randomization=0,
                     amp_randomization=0, randomize_freq_sign=True, randomize_phase=True):
    log_freqs = [math.log(slowest_freq) + math.log(freq_ratio) * random.uniform(n - freq_randomization / 2, n + freq_randomization / 2)
                 for n in range(num_sines)]
    freqs = [round(math.exp(lf), 10) * (random.choice([-1, 1]) if randomize_freq_sign else 1) for lf in log_freqs]
    
    log_amps = [math.log(amp_ratio) * random.uniform(n - amp_randomization / 2, n + amp_randomization / 2)
                 for n in range(num_sines)]
    amps = [round(math.exp(la), 10) for la in log_amps]
    return [
        (f, a, random.uniform(0, math.tau) if randomize_phase else 0)
        for f, a in zip(freqs, reversed(amps))
    ]

random.seed(14)
# sines = get_random_sines(4, 0.1, 2, 1.5, freq_randomization=0.5, amp_randomization=0.5)
sines = [(0.09259259259259259, 0.4464285714285714, -5.92693289186054e-16), (0.4629629629629629, 0.0778011206670387, -0.7617419260477534), (-0.2777777777777778, 0.07780112066703865, 0.7617419260477537), (0.18518518518518517, 0.07458894919018154, -0.6066568835966398), (0.0, 0.0745889491901815, 0.6066568835966394), (-0.09259259259259259, 0.04609180880586724, 1.8767759487111393), (0.2777777777777778, 0.04609180880586722, -1.8767759487111393), (-1.0185185185185184, 0.037698412698412676, 6.135443030823237e-16), (-0.6481481481481481, 0.026466907880861312, -2.759022775272237), (0.8333333333333333, 0.026466907880861267, 2.7590227752722325), (0.5555555555555556, 0.024810765205970114, 1.3124939248177807), (-0.37037037037037035, 0.024810765205970083, -1.312493924817782), (0.7407407407407407, 0.024250064496701407, 0.0670041935546617), (-0.5555555555555556, 0.024250064496701338, -0.06700419355466326), (-0.18518518518518517, 0.023515026020494212, 2.886319214029976), (0.37037037037037035, 0.02351502602049417, -2.8863192140299763), (-0.7407407407407407, 0.01157618900634222, 1.226826990962476), (0.9259259259259258, 0.01157618900634219, -1.2268269909624785), (0.6481481481481481, 0.011311264137888286, 1.30454427764397), (-0.4629629629629629, 0.011311264137888244, -1.3045442776439717), (0.1388888888888889, 0.008692232411028032, 0.33167905759136573), (0.046296296296296294, 0.00869223241102785, -0.33167905759136773), (-0.41666666666666663, 0.007404571767010181, -2.6927091660243985), (0.6018518518518519, 0.007404571767010156, 2.6927091660243967), (-0.32407407407407407, 0.007104263434702683, -1.9145784879432843), (0.5092592592592592, 0.007104263434702676, 1.9145784879432748), (0.23148148148148145, 0.007064448829760071, 0.9176956346027572), (-0.046296296296296294, 0.007064448829760025, -0.9176956346027718), (-0.8333333333333333, 0.0062285407670074665, 1.7315306132000705), (1.0185185185185184, 0.0062285407670074336, -1.731530613200076), (0.6944444444444444, 0.006136991920696015, -2.653454288512399), (-0.5092592592592592, 0.006136991920696, 2.6534542885123944), (-0.23148148148148145, 0.005702156151996804, -1.3924639468379465), (0.41666666666666663, 0.005702156151996784, 1.3924639468379367), (-0.1388888888888889, 0.005322716750698317, -1.2252338285870366), (0.32407407407407407, 0.005322716750698301, 1.225233828587023), (-0.6018518518518519, 0.00401455334490139, 1.498493680046263), (0.787037037037037, 0.004014553344901376, -1.498493680046258), (-0.787037037037037, 0.0026048626249265024, -1.6607922446466414), (0.9722222222222222, 0.0026048626249264937, 1.6607922446466288)]

circle_spectrum = CircleSpectrum(*sines, cutoff_index=transitions_envelope)
circle_spectrum_music = circle_spectrum
circle_spectrum_graphics = circle_spectrum.normalized(WINDOW_DIM[1] / 2)



# 13.613319158554077 0.5492606591783147 0.3367327528210926
